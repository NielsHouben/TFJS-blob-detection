<!DOCTYPE html>
<html>

<head>
    <title>opencv.js sandbox</title>
    <meta charset="UTF-8" />
</head>

<body>
    <div>
        <video id="videoInput"></video> <canvas id="canvasOutput"></canvas>
        <button id="startCameraButton" onclick="startCamera()" disabled>startCamera </button>
    </div>
    <script>

        // const FPS = 0.1;
        // function notify () {
        //     alert("notifying you");
        //     // let begin = Date.now();
        //     setTimeout(notify, 6000);

        // }

        // // schedule the first one.
        // // console.log("dsl");
        // setTimeout(notify, 0);

        // alert("hubuebulabub");
        // Adapted from https://docs.opencv.org/3.4/dd/d00/tutorial_js_video_display.html
        let video = document.getElementById("videoInput"); // video is the id of video tag
        video.width = 640;
        video.height = 480;

        // make button available here
        function onOpenCvReady () {
            // alert("opencv is ready");
            document.getElementById("startCameraButton").disabled = false;
        }

        async function startCamera () {
            const stream = await navigator.mediaDevices
                .getUserMedia({ video: true, audio: false })
                .catch(function (err) {
                    console.log("An error occurred! " + err);
                });

            alert(video.srcObject);

            video.srcObject = stream;
            video.play();
            alert(video.srcObject);

            let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
            let cap = new cv.VideoCapture(video);

            // const FPS = 30;
            const FPS = 30;
            function processVideo () {
                try {
                    // alert("doing thing");
                    // if (!streaming) {
                    //   // clean and stop.
                    //   src.delete();
                    //   dst.delete();
                    //   return;
                    // }
                    let begin = Date.now();
                    // start processing.
                    cap.read(src);
                    cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                    cv.imshow("canvasOutput", dst);
                    // schedule the next one.
                    let delay = 1000 / FPS - (Date.now() - begin);
                    setTimeout(processVideo, delay);
                } catch (err) {
                    console.error(err);
                }
            }

            // schedule the first one.
            setTimeout(processVideo, 0);
        }

    </script>

    <!-- <script src="src/index.js?version=1"></script> -->
    <script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</body>

</html>